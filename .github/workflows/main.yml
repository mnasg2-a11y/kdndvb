name: Permanent-VPS-with-Tailscale
on:
  workflow_dispatch:
  schedule:
    - cron: '*/55 * * * *'  # ูุชุฌุฏุฏ ูู 55 ุฏูููุฉ

jobs:
  permanent-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 0
    
    steps:
      - name: Start Permanent VPS
        run: |
          echo "๐ ุจุฏุก VPS ุฏุงุฆู ูุน Tailscale..."
          echo "โฐ ุงูููุช: $(date)"
          echo "๐ ุณูุฑุจุท ุจู Tailscale ุชููุงุฆูุงู"

      - name: Install System Requirements
        run: |
          sudo apt update -y
          sudo apt install -y openssh-server curl wget screen
          echo "โ ุงููุธุงู ุฌุงูุฒ"

      - name: Configure Permanent SSH
        run: |
          sudo systemctl enable ssh
          sudo systemctl start ssh
          
          # ูููุฉ ูุฑูุฑ ุณููุฉ ููุชุฐูุฑ
          echo "root:vps123456" | sudo chpasswd
          
          # ุฅุนุฏุงุฏุงุช SSH ุฏุงุฆูุฉ
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          echo "ClientAliveInterval 30" | sudo tee -a /etc/ssh/sshd_config
          echo "ClientAliveCountMax 86400" | sudo tee -a /etc/ssh/sshd_config
          
          sudo systemctl restart ssh
          echo "โ SSH ุฌุงูุฒ | User: root | Pass: vps123456"

      - name: Setup Tailscale Connection
        run: |
          # ุชุซุจูุช Tailscale
          echo "โฌ๏ธ ุฌุงุฑู ุชุซุจูุช Tailscale..."
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # ุชุดุบูู Tailscale ูุน ุงูููุชุงุญ ุงูุณุฑู
          echo "๐ ุฌุงุฑู ุงูุงุชุตุงู ุจู Tailscale..."
          sudo tailscale up \
            --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" \
            --hostname="github-vps-$(date +%s)" \
            --accept-dns=false \
            --accept-routes \
            --reset
          
          # ุงูุชุธุงุฑ ุงูุงุชุตุงู
          sleep 15
          
          # ุงูุญุตูู ุนูู IP
          TS_IP=$(tailscale ip -4 | head -n 1)
          
          if [ -z "$TS_IP" ]; then
            echo "โ ูุดู ุงูุงุชุตุงู ุจู Tailscale"
            echo "โ๏ธ ุชุฃูุฏ ูู:"
            echo "1. Auth Key ุตุญูุญ ูู GitHub Secrets"
            echo "2. ุญุณุงุจ Tailscale ูุดุท"
            exit 1
          fi
          
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "โ ุงุชุตุงู Tailscale ูุงุฌุญ!"
          echo "๐ IP ุงูุฎุงุต ุจู: $TS_IP"
          echo "๐ฅ๏ธ  ููุงุชุตุงู: ssh root@$TS_IP"
          echo "๐ ูููุฉ ุงููุฑูุฑ: vps123456"

      - name: Create Always-Online System
        run: |
          # ูุธุงู ุงูุจูุงุก ูุชุตู ููุฃุจุฏ
          cat << 'EOF' > /always_online.sh
          #!/bin/bash
          
          echo "๐ ูุธุงู ุงูุงุชุตุงู ุงูุฏุงุฆู ูุนูู..."
          echo "๐ ุงูุจุฏุก: $(date)"
          
          while true; do
            # ุงูุชุญูู ูู Tailscale
            if ! tailscale status 2>/dev/null | grep -q "active"; then
              echo "โ๏ธ ููุฏุงู ุงูุงุชุตุงูุ ุฅุนุงุฏุฉ ุงููุญุงููุฉ..."
              
              # ุฅุนุงุฏุฉ ุงูุงุชุตุงู
              sudo tailscale up \
                --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" \
                --hostname="github-vps-reconnect-$(date +%s)" \
                --accept-dns=false \
                --reset
              
              sleep 10
              NEW_IP=$(tailscale ip -4 | head -n 1)
              echo "โ ูุชุตู ูุฑุฉ ุฃุฎุฑู! IP: $NEW_IP"
            fi
            
            # ุนุฑุถ ุงูุญุงูุฉ ูู 5 ุฏูุงุฆู
            IP=$(tailscale ip -4 | head -n 1 2>/dev/null || echo "ุฌุงุฑู ุงูุงุชุตุงู...")
            echo "๐ [$IP] - $(date)"
            
            sleep 300
          done
          EOF
          
          chmod +x /always_online.sh
          
          # ุชุดุบููู ูู ุงูุฎูููุฉ
          screen -dmS always-online bash -c "/always_online.sh"
          
          echo "โ ูุธุงู ุงูุงุชุตุงู ุงูุฏุงุฆู ูุนูู ูู ุงูุฎูููุฉ"

      - name: Display Connection Info
        run: |
          TS_IP=$(tailscale ip -4 | head -n 1)
          
          echo ""
          echo "========================================="
          echo "๐ VPS ุฌุงูุฒ ููุงุณุชุฎุฏุงู!"
          echo "========================================="
          echo ""
          echo "๐ ูุนูููุงุช ุงูุงุชุตุงู:"
          echo "๐ IP: $TS_IP"
          echo "๐ฅ๏ธ  SSH Command: ssh root@$TS_IP"
          echo "๐ Password: vps123456"
          echo ""
          echo "โ๏ธ ููุฒุงุช ุงููุธุงู:"
          echo "โ ุงุชุตุงู Tailscale ุฏุงุฆู"
          echo "โ ุฅุนุงุฏุฉ ุงุชุตุงู ุชููุงุฆู"
          echo "โ SSH ูุชุงุญ 24/7"
          echo "โ ุชุฌุฏูุฏ ุชููุงุฆู ูู 55 ุฏูููุฉ"
          echo ""
          echo "๐ฑ ููุงุชุตุงู ูู ุฃู ุฌูุงุฒ:"
          echo "1. ุญูู ุชุทุจูู Tailscale"
          echo "2. ุณุฌู ุงูุฏุฎูู ุจููุณ ุญุณุงุจู"
          echo "3. ุงุชุตู ุนุจุฑ: ssh root@$TS_IP"
          echo ""
          echo "๐ง ุงุณุชูุดุงู ุงูุฃุฎุทุงุก:"
          echo "โข ุชุญูู ูู Tailscale Admin Console"
          echo "โข ุชุฃูุฏ ูู ุชูุนูู ุงูุฌูุงุฒ"
          echo "โข ุฌุฑุจ ุฅุนุงุฏุฉ ุงูุชุดุบูู ุฅุฐุง ูุฒู ุงูุฃูุฑ"
          echo ""
          echo "โฐ ููุช ุงูุจุฏุก: $(date)"
          echo "========================================="

      - name: Keep Alive Forever
        run: |
          echo "๐ VPS ูุนูู ุจุดูู ุฏุงุฆู..."
          echo "๐ก ูุฑุงูุจุฉ ุงูุงุชุตุงู..."
          
          # ุญููุฉ ุงูุจูุงุก ูุดุทุงู
          counter=0
          while true; do
            IP=$(tailscale ip -4 | head -n 1 2>/dev/null || echo "ูู ุงูุงูุชุธุงุฑ...")
            
            # ุชุญุฏูุซ ูู 30 ุฏูููุฉ
            if [ $((counter % 30)) -eq 0 ]; then
              echo ""
              echo "๐ ุชุญุฏูุซ ุงูุญุงูุฉ - $(date)"
              echo "๐ IP: $IP"
              echo "โฑ๏ธ  ููุช ุงูุชุดุบูู: $((counter/2)) ุณุงุนุฉ"
              echo "๐ SSH: ssh root@$IP"
            fi
            
            sleep 120
            counter=$((counter + 1))
          done
